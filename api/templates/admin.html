{% extends "base.html" %}

{% block title %}Admin Panel - Content Hub{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Admin Panel</h2>
        
        <!-- User Management -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">User Management</h3>
            <div class="mb-3">
                <div class="relative">
                    <svg class="absolute left-3 top-3 w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input
                        type="text"
                        id="userSearch"
                        placeholder="Search users..."
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg"
                        onkeyup="filterUsers()"
                    />
                </div>
            </div>
            <div id="usersList" class="space-y-2 max-h-96 overflow-y-auto">
                {% for user in users %}
                <div class="user-row flex items-center justify-between p-3 bg-gray-50 rounded" data-username="{{ user.username.lower() }}">
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">{{ user.username }}</p>
                        <p class="text-xs text-gray-500">
                            {% if user.is_admin %}Administrator{% else %}User{% endif %}
                        </p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button
                            onclick="toggleSubscription('{{ user._id }}', {{ 'true' if user.is_subscribed else 'false' }})"
                            class="px-3 py-1 text-xs rounded {% if user.is_subscribed %}bg-green-100 text-green-700{% else %}bg-gray-200 text-gray-700{% endif %}"
                        >
                            {% if user.is_subscribed %}Subscribed{% else %}Free{% endif %}
                        </button>
                        {% if user._id|string != session.get('user_id')|string %}
                        <button
                            onclick="deleteUser('{{ user._id }}')"
                            class="p-1 text-red-600 hover:bg-red-50 rounded"
                        >
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Category Management -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">Category Management</h3>
            
            <!-- Add Category Form -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <h4 class="font-medium mb-3 text-gray-700">Add New Category</h4>
                <div class="space-y-2">
                    <input
                        type="text"
                        id="newCategoryName"
                        placeholder="Category name"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    />
                    <textarea
                        id="newCategoryDescription"
                        placeholder="Category description (optional)"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg h-20"
                    ></textarea>
                    <div class="flex gap-2">
                        <input
                            type="text"
                            id="newCategoryColor"
                            placeholder="Accent Color (e.g., #4F46E5)"
                            value="#4F46E5"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg font-mono"
                        />
                        <div 
                            id="newColorPreview"
                            class="w-12 h-10 rounded border-2 border-gray-300"
                            style="background-color: #4F46E5"
                        ></div>
                        <label class="flex items-center gap-2 px-4 py-2 bg-white rounded-lg cursor-pointer border border-gray-300">
                            <input
                                type="checkbox"
                                id="newCategoryFree"
                                class="w-4 h-4"
                            />
                            <span class="text-sm">Free</span>
                        </label>
                        <button
                            onclick="addCategory()"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                        >
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Categories List -->
            <div class="space-y-2">
                {% for category in categories %}
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div class="flex items-center gap-3 flex-1">
                        <div 
                            class="w-3 h-3 rounded-full" 
                            style="background-color: {{ category.accent_color }}"
                        ></div>
                        <div>
                            <p class="font-medium text-gray-800">{{ category.name }}</p>
                            {% if category.description %}
                            <p class="text-xs text-gray-500">{{ category.description[:50] }}{% if category.description|length > 50 %}...{% endif %}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs px-3 py-1 rounded {% if category.is_free %}bg-green-100 text-green-700{% else %}bg-purple-100 text-purple-700{% endif %}">
                            {% if category.is_free %}Free{% else %}Premium{% endif %}
                        </span>
                        <a
                            href="/category/{{ category._id }}"
                            class="p-1 text-indigo-600 hover:bg-indigo-50 rounded"
                        >
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </a>
                        <button
                            onclick="deleteCategory('{{ category._id }}')"
                            class="p-1 text-red-600 hover:bg-red-50 rounded"
                        >
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-indigo-50 p-4 rounded-lg">
                <p class="text-sm text-indigo-600 font-medium">Total Users</p>
                <p class="text-2xl font-bold text-indigo-900">{{ users|length }}</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
                <p class="text-sm text-green-600 font-medium">Subscribed Users</p>
                <p class="text-2xl font-bold text-green-900">{{ users|selectattr('is_subscribed')|list|length }}</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
                <p class="text-sm text-purple-600 font-medium">Total Categories</p>
                <p class="text-2xl font-bold text-purple-900">{{ categories|length }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function filterUsers() {
        const searchTerm = document.getElementById('userSearch').value.toLowerCase();
        const userRows = document.querySelectorAll('.user-row');
        
        userRows.forEach(row => {
            const username = row.getAttribute('data-username');
            if (username.includes(searchTerm)) {
                row.style.display = 'flex';
            } else {
                row.style.display = 'none';
            }
        });
    }

    function toggleSubscription(userId, currentStatus) {
        fetch(`/api/users/${userId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_subscribed: !currentStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update subscription');
        });
    }

    function deleteUser(userId) {
        if (!confirm('Delete this user?')) return;

        fetch(`/api/users/${userId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete user');
        });
    }

    function addCategory() {
        const name = document.getElementById('newCategoryName').value;
        const description = document.getElementById('newCategoryDescription').value;
        const accentColor = document.getElementById('newCategoryColor').value;
        const isFree = document.getElementById('newCategoryFree').checked;

        if (!name) {
            alert('Please enter a category name');
            return;
        }

        if (!/^#[0-9A-F]{6}$/i.test(accentColor)) {
            alert('Please enter a valid hex color code (e.g., #4F46E5)');
            return;
        }

        fetch('/api/categories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                name, 
                description, 
                accent_color: accentColor, 
                is_free: isFree 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add category');
        });
    }

    function deleteCategory(categoryId) {
        if (!confirm('Delete this category and all its content?')) return;

        fetch(`/api/categories/${categoryId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete category');
        });
    }

    // Update color preview
    document.addEventListener('DOMContentLoaded', function() {
        const colorInput = document.getElementById('newCategoryColor');
        const colorPreview = document.getElementById('newColorPreview');
        
        if (colorInput && colorPreview) {
            colorInput.addEventListener('input', function() {
                if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                    colorPreview.style.backgroundColor = this.value;
                }
            });
        }
    });
</script>
{% endblock %}
