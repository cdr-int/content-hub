{% extends "base.html" %}

{% block title %}{{ category.name }} - Effexor Hub{% endblock %}

{% block content %}
<style>
    .category-accent-btn {
        background-color: {{ category.accent_color }};
    }
    .category-accent-btn:hover {
        opacity: 0.9;
    }
    .category-accent-border:hover {
        border-color: {{ category.accent_color }};
    }
    .category-accent-text {
        color: {{ category.accent_color }};
    }
    .category-accent-bg {
        background-color: {{ category.accent_color }}20;
    }
    .category-accent-ring:focus {
        --tw-ring-color: {{ category.accent_color }};
    }
    
    /* Mobile responsive grid */
    @media (max-width: 640px) {
        .content-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
    }
    
    @media (min-width: 640px) {
        .content-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
    }
    
    /* Make cards fit content */
    .content-card {
        height: fit-content;
    }
    
    .content-card img,
    .content-card video {
        width: 100%;
        height: auto;
        display: block;
    }
    
    /* Lightbox styles */
    .lightbox {
        display: none;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        animation: fadeIn 0.2s ease-in;
    }
    
    .lightbox.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .lightbox-content {
        max-width: 95vw;
        max-height: 95vh;
        object-fit: contain;
        animation: zoomIn 0.3s ease-out;
    }
    
    .lightbox-close {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        z-index: 10000;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        transition: all 0.3s;
        line-height: 1;
        padding: 0;
    }
    
    .lightbox-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .lightbox-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        color: white;
        padding: 30px 20px 20px;
        text-align: center;
    }
    
    .lightbox-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .lightbox-caption {
        font-size: 1rem;
        opacity: 0.9;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes zoomIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    
    /* Click indicator on hover */
    .media-item {
        cursor: pointer;
        position: relative;
    }
    
    .media-item::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
        background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="black"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/></svg>');
        background-size: 60%;
        background-position: center;
        background-repeat: no-repeat;
    }
    
    .media-item:hover::after {
        opacity: 1;
    }
    
    /* Hover overlay for titles and captions */
    .content-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.7) 70%, transparent);
        color: white;
        padding: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 10;
    }
    
    .content-card:hover .content-overlay {
        opacity: 1;
    }
    
    .content-overlay-title {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 4px;
        line-height: 1.2;
    }
    
    .content-overlay-caption {
        font-size: 0.75rem;
        opacity: 0.9;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    @media (min-width: 640px) {
        .content-overlay {
            padding: 16px;
        }
        
        .content-overlay-title {
            font-size: 1rem;
        }
        
        .content-overlay-caption {
            font-size: 0.875rem;
        }
    }
</style>

<div class="max-w-7xl mx-auto px-2 sm:px-4 py-4 sm:py-8">
    <div class="rounded-lg sm:rounded-xl shadow-lg overflow-hidden" style="background-color: rgb(18, 18, 20);">
        <!-- Category Header -->
        <div class="relative overflow-hidden" style="min-height: 150px;">
            <!-- Mobile: 150px, Desktop keeps larger height via responsive padding -->
            <!-- Background: Banner Image or Gradient -->
            {% if category.banner_image %}
            <div class="absolute inset-0">
                <img src="{{ category.banner_image }}" alt="{{ category.name }}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/50 to-black/30"></div>
            </div>
            {% else %}
            <div class="absolute inset-0 gradient-bg" style="--gradient-start: {{ category.accent_color }}; --gradient-end: {{ category.accent_color }}dd;">
                <!-- Decorative Pattern -->
                <div class="absolute inset-0 opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;%3E%3Cg fill=&quot;%23ffffff&quot; fill-opacity=&quot;1&quot;%3E%3Cpath d=&quot;M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z&quot;/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
            </div>
            {% endif %}
            
            <!-- Content -->
            <div class="px-4 sm:px-6 py-4 sm:py-8 text-white relative z-10">
            
            <div class="flex flex-col sm:flex-row justify-between items-start gap-4 relative z-10">
                <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-2 sm:gap-3 mb-2">
                        <h2 class="text-2xl sm:text-3xl font-bold">{{ category.name }}</h2>
                        <span class="px-2 sm:px-3 py-1 rounded-full text-xs font-semibold {% if category.is_free %}bg-green-500{% else %}bg-purple-500{% endif %}">
                            {% if category.is_free %}Free{% else %}Premium{% endif %}
                        </span>
                    </div>
                    {% if category.description %}
                    <p class="text-white/90 text-sm sm:text-base mt-2 sm:mt-3 max-w-3xl whitespace-pre-wrap">{{ category.description }}</p>
                    {% endif %}
                </div>
                {% if is_admin %}
                <div class="flex gap-2 self-start">
                    <button onclick="toggleEditCategory()" class="p-2 text-white hover:bg-gray-900/20 rounded-lg transition" title="Edit Category">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                </div>
                {% endif %}
            </div>
            </div>
        </div>

        <!-- Edit Category Form -->
        {% if is_admin %}
        <div id="editCategoryForm" class="hidden p-4 sm:p-6 bg-gray-800/50 border-b border-gray-700">
            <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 text-gray-300">Edit Category</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Category Name</label>
                    <input
                        type="text"
                        id="categoryName"
                        value="{{ category.name }}"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-600 rounded-lg text-sm sm:text-base bg-gray-800/50 text-gray-200 placeholder-gray-500"
                    />
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Description</label>
                    <textarea
                        id="categoryDescription"
                        class="w-full px-3 sm:px-4 py-2 border border-gray-600 rounded-lg h-20 text-sm sm:text-base bg-gray-800/50 text-gray-200 placeholder-gray-500"
                    >{{ category.description }}</textarea>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Banner Image URL (optional)</label>
                    <div class="relative">
                        <input
                            type="url"
                            id="categoryBannerImage"
                            value="{{ category.banner_image if category.banner_image else '' }}"
                            placeholder="https://example.com/banner.jpg"
                            class="w-full px-3 sm:px-4 py-2 pr-8 border border-gray-600 rounded-lg text-sm sm:text-base bg-gray-800/50 text-gray-200 placeholder-gray-500"
                        />
                        <button
                            onclick="clearBannerInput('categoryBannerImage')"
                            class="absolute right-2 top-1/2 -translate-y-1/2 w-5 h-5 flex items-center justify-center text-gray-400 hover:text-gray-200 transition-colors"
                            title="Clear banner URL"
                        >
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Recommended size: 1200Ã—400 pixels (3:1 ratio)</p>
                </div>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Accent Color</label>
                        <div class="relative">
                            <input
                                type="text"
                                id="categoryColor"
                                value="{{ category.accent_color }}"
                                class="hidden min-[425px]:block w-full px-3 sm:px-4 py-2 pr-8 border border-gray-600 rounded-lg font-mono text-sm sm:text-base bg-gray-800/50 text-gray-200"
                            />
                            <button
                                onclick="clearColorInput('categoryColor', 'categoryColorPicker')"
                                class="hidden min-[425px]:flex absolute right-2 top-1/2 -translate-y-1/2 w-5 h-5 items-center justify-center text-gray-400 hover:text-gray-200 transition-colors"
                                title="Clear color"
                            >
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Preview</label>
                        <input
                            type="color"
                            id="categoryColorPicker"
                            value="{{ category.accent_color }}"
                            class="w-12 h-10 rounded border-2 border-gray-600 cursor-pointer bg-gray-800"
                            style="padding: 2px; min-width: 2.5rem;"
                        />
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Free</label>
                        <label class="flex items-center h-10 px-3 sm:px-4 bg-gray-800/50 rounded-lg cursor-pointer border border-gray-600">
                            <input
                                type="checkbox"
                                id="categoryFree"
                                {% if category.is_free %}checked{% endif %}
                                class="w-4 h-4"
                            />
                        </label>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button
                        onclick="saveCategory()"
                        class="px-4 py-2 category-accent-btn text-white rounded-lg hover:opacity-90 text-sm sm:text-base"
                    >
                        Save Changes
                    </button>
                    <button
                        onclick="toggleEditCategory()"
                        class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 text-sm sm:text-base"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Admin Controls -->
        {% if is_admin %}
        <div class="p-4 sm:p-6 border-b border-gray-700">
            <div class="flex flex-wrap gap-2">
                <button
                    onclick="toggleAddContent()"
                    class="flex items-center gap-2 px-3 sm:px-4 py-2 category-accent-btn text-white rounded-lg hover:opacity-90 text-sm sm:text-base"
                >
                    <svg class="w-4 sm:w-5 h-4 sm:h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Add Content
                </button>
                <button
                    onclick="toggleBulkUpload()"
                    class="flex items-center gap-2 px-3 sm:px-4 py-2 bg-[#21525D] text-white rounded-lg hover:bg-[#1A1A1E] text-sm sm:text-base"
                >
                    <svg class="w-4 sm:w-5 h-4 sm:h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    Bulk Upload
                </button>
                <button
                    onclick="toggleAddFolder()"
                    class="flex items-center gap-2 px-3 sm:px-4 py-2 bg-[#21525D] text-white rounded-lg hover:bg-[#1A1A1E] text-sm sm:text-base"
                >
                    <svg class="w-4 sm:w-5 h-4 sm:h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                    </svg>
                    Add Folder
                </button>
            </div>

            <!-- Add Content Form -->
            <div id="addContentForm" class="hidden mt-4 p-4 bg-gray-800/50 rounded-lg">
                <h3 class="font-medium mb-3 text-gray-300 text-sm sm:text-base">Add New Content</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Content Type</label>
                        <select id="newContentType" class="w-full px-3 sm:px-4 py-2 border border-gray-600 rounded-lg text-sm sm:text-base bg-gray-800/50 text-gray-200" onchange="toggleContentFields()">
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                            <option value="text">Text</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Folder (optional)</label>
                        <select id="newContentFolder" class="w-full px-3 sm:px-4 py-2 border border-gray-600 rounded-lg text-sm sm:text-base bg-gray-800/50 text-gray-200">
                            <option value="">Root (No Folder)</option>
                            {% for folder in folders %}
                            <option value="{{ folder._id }}">{{ folder.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Title (optional)</label>
                        <input
                            type="text"
                            id="newContentTitle"
                            placeholder="Content title"
                            class="w-full px-3 sm:px-4 py-2 border border-gray-600 rounded-lg text-sm sm:text-base bg-gray-800/50 text-gray-200 placeholder-gray-500"
                        />
                    </div>
                    <div id="contentUrlField">
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Media URL</label>
                        <input
                            type="url"
                            id="newContentUrl"
                            placeholder="https://example.com/image.jpg"
                            class="w-full px-3 sm:px-4 py-2 border border-gray-600 rounded-lg text-sm sm:text-base bg-gray-800/50 text-gray-200 placeholder-gray-500"
                        />
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Caption/Text</label>
                        <textarea
                            id="newContentCaption"
                            placeholder="Content caption or description"
                            class="w-full px-3 sm:px-4 py-2 border border-gray-600 rounded-lg h-20 text-sm sm:text-base bg-gray-800/50 text-gray-200 placeholder-gray-500"
                        ></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button
                            onclick="addContent()"
                            class="px-4 py-2 category-accent-btn text-white rounded-lg hover:opacity-90 text-sm sm:text-base"
                        >
                            Add Content
                        </button>
                        <button
                            onclick="toggleAddContent()"
                            class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 text-sm sm:text-base"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bulk Upload Form -->
            <div id="bulkUploadForm" class="hidden mt-4 p-4 bg-gray-800/50 rounded-lg">
                <h3 class="font-medium mb-3 text-gray-300 text-sm sm:text-base">Bulk Upload URLs</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Media Type</label>
                        <select id="bulkMediaType" class="w-full px-3 sm:px-4 py-2 border border-gray-600 rounded-lg text-sm sm:text-base bg-gray-800/50 text-gray-200">
                            <option value="image">Images</option>
                            <option value="video">Videos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Folder (optional)</label>
                        <select id="bulkContentFolder" class="w-full px-3 sm:px-4 py-2 border border-gray-600 rounded-lg text-sm sm:text-base bg-gray-800/50 text-gray-200">
                            <option value="">Root (No Folder)</option>
                            {% for folder in folders %}
                            <option value="{{ folder._id }}">{{ folder.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">URLs (one per line)</label>
                        <textarea
                            id="bulkUrls"
                            placeholder="https://example.com/image1.jpg
https://example.com/image2.jpg
https://example.com/image3.jpg"
                            class="w-full px-3 sm:px-4 py-2 border border-gray-600 rounded-lg h-32 text-sm sm:text-base bg-gray-800/50 text-gray-200 placeholder-gray-500 font-mono"
                        ></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button
                            onclick="bulkUpload()"
                            class="px-4 py-2 bg-[#21525D] text-white rounded-lg hover:bg-[#1A1A1E] text-sm sm:text-base"
                        >
                            Upload All
                        </button>
                        <button
                            onclick="toggleBulkUpload()"
                            class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 text-sm sm:text-base"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Add Folder Form -->
            <div id="addFolderForm" class="hidden mt-4 p-4 bg-gray-800/50 rounded-lg">
                <h3 class="font-medium mb-3 text-gray-300 text-sm sm:text-base">Create New Folder</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Folder Name</label>
                        <input
                            type="text"
                            id="newFolderName"
                            placeholder="Enter folder name"
                            class="w-full px-3 sm:px-4 py-2 border border-gray-600 rounded-lg text-sm sm:text-base bg-gray-800/50 text-gray-200 placeholder-gray-500"
                        />
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-400 mb-1">Description (optional)</label>
                        <textarea
                            id="newFolderDescription"
                            placeholder="Folder description"
                            class="w-full px-3 sm:px-4 py-2 border border-gray-600 rounded-lg h-20 text-sm sm:text-base bg-gray-800/50 text-gray-200 placeholder-gray-500"
                        ></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button
                            onclick="addFolder()"
                            class="px-4 py-2 bg-[#21525D] text-white rounded-lg hover:bg-[#1A1A1E] text-sm sm:text-base"
                        >
                            Create Folder
                        </button>
                        <button
                            onclick="toggleAddFolder()"
                            class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 text-sm sm:text-base"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Folders Section -->
        {% if folders|length > 0 %}
        <div class="p-4 sm:p-6 border-b border-gray-700">
            <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 text-gray-300">Folders</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4">
                {% for folder in folders %}
                <div class="group relative bg-gray-800/50 rounded-lg p-4 hover:bg-gray-700/50 transition cursor-pointer" onclick="openFolder('{{ folder._id }}')">
                    <div class="flex items-start justify-between mb-2">
                        <svg class="w-10 h-10 sm:w-12 sm:h-12 category-accent-text" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                        </svg>
                        {% if is_admin %}
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition" onclick="event.stopPropagation()">
                            <button
                                onclick="editFolder('{{ folder._id }}', '{{ folder.name }}', '{{ folder.description }}')"
                                class="p-1 text-gray-400 hover:text-white hover:bg-gray-600 rounded"
                                title="Edit folder"
                            >
                                <svg class="w-3.5 sm:w-4 h-3.5 sm:h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button
                                onclick="deleteFolder('{{ folder._id }}')"
                                class="p-1 text-red-400 hover:text-red-300 hover:bg-red-500/20 rounded"
                                title="Delete folder"
                            >
                                <svg class="w-3.5 sm:w-4 h-3.5 sm:h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    <h4 class="font-semibold text-gray-200 text-sm sm:text-base truncate">{{ folder.name }}</h4>
                    {% if folder.description %}
                    <p class="text-xs text-gray-500 mt-1 line-clamp-2">{{ folder.description }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Content Grid -->
        <div class="p-4 sm:p-6">
            <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 text-gray-300">Content</h3>
            {% if content_items|length > 0 %}
            <div class="content-grid grid gap-3 sm:gap-4">
                {% for item in content_items %}
                <div id="content-{{ item._id }}" class="content-card group relative bg-gray-800/50 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300">
                    <!-- Content Display -->
                    <div id="content-display-{{ item._id }}">
                        {% if item.media_type == 'image' %}
                        <div class="media-item" onclick="openLightbox('{{ item.media_url }}', 'image', '{{ item.title }}', '{{ item.caption }}')">
                            <img src="{{ item.media_url }}" alt="{{ item.title }}" loading="lazy" class="w-full h-auto">
                            {% if item.title or item.caption %}
                            <div class="content-overlay">
                                {% if item.title %}<div class="content-overlay-title">{{ item.title }}</div>{% endif %}
                                {% if item.caption %}<div class="content-overlay-caption">{{ item.caption }}</div>{% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% elif item.media_type == 'video' %}
                        <div class="relative">
                            <video controls class="w-full h-auto">
                                <source src="{{ item.media_url }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            {% if item.title or item.caption %}
                            <div class="content-overlay">
                                {% if item.title %}<div class="content-overlay-title">{{ item.title }}</div>{% endif %}
                                {% if item.caption %}<div class="content-overlay-caption">{{ item.caption }}</div>{% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="p-4">
                            {% if item.title %}
                            <h4 class="font-semibold text-gray-200 text-base mb-2">{{ item.title }}</h4>
                            {% endif %}
                            <p class="text-gray-400 text-sm whitespace-pre-wrap">{{ item.text or item.caption }}</p>
                        </div>
                        {% endif %}

                        <!-- Favorite Button (for all users) -->
                        <button 
                            onclick="toggleFavorite('{{ item._id }}', this)"
                            class="favorite-btn absolute top-2 left-2 w-9 h-9 rounded-full bg-black/70 hover:bg-black/90 flex items-center justify-center transition-all shadow-lg z-20"
                            data-favorited="false"
                            data-content-id="{{ item._id }}"
                        >
                            <svg class="heart-icon w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                        </button>

                        {% if is_admin %}
                        <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition z-20">
                            <button
                                onclick="toggleEdit('{{ item._id }}')"
                                class="p-2 bg-gray-900/90 text-white rounded hover:bg-gray-800"
                                title="Edit"
                            >
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button
                                onclick="deleteContent('{{ item._id }}')"
                                class="p-2 bg-red-600/90 text-white rounded hover:bg-red-700"
                                title="Delete"
                            >
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Edit Form -->
                    {% if is_admin %}
                    <div id="edit-form-{{ item._id }}" class="hidden p-4 bg-gray-800/50">
                        <h4 class="font-semibold text-gray-200 mb-3 text-sm">Edit Content</h4>
                        <div class="space-y-2">
                            <input
                                type="text"
                                id="edit-title-{{ item._id }}"
                                value="{{ item.title }}"
                                placeholder="Title"
                                class="w-full px-3 py-2 border border-gray-600 rounded text-sm bg-gray-800/50 text-gray-200 placeholder-gray-500"
                            />
                            {% if item.media_type != 'text' %}
                            <input
                                type="url"
                                id="edit-url-{{ item._id }}"
                                value="{{ item.media_url }}"
                                placeholder="Media URL"
                                class="w-full px-3 py-2 border border-gray-600 rounded text-sm bg-gray-800/50 text-gray-200 placeholder-gray-500"
                            />
                            {% endif %}
                            <textarea
                                id="edit-caption-{{ item._id }}"
                                placeholder="Caption/Text"
                                class="w-full px-3 py-2 border border-gray-600 rounded h-20 text-sm bg-gray-800/50 text-gray-200 placeholder-gray-500"
                            >{{ item.caption or item.text }}</textarea>
                            <select id="edit-folder-{{ item._id }}" class="w-full px-3 py-2 border border-gray-600 rounded text-sm bg-gray-800/50 text-gray-200">
                                <option value="">Root (No Folder)</option>
                                {% for folder in folders %}
                                <option value="{{ folder._id }}" {% if item.folder_id == folder._id %}selected{% endif %}>{{ folder.name }}</option>
                                {% endfor %}
                            </select>
                            <div class="flex gap-2">
                                <button
                                    onclick="saveContentEdit('{{ item._id }}')"
                                    class="px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
                                >
                                    Save
                                </button>
                                <button
                                    onclick="cancelEdit('{{ item._id }}')"
                                    class="px-3 py-1.5 bg-gray-700 text-white rounded hover:bg-gray-600 text-sm"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                </svg>
                <p class="text-gray-500 text-sm sm:text-base">No content in this category yet.</p>
                {% if is_admin %}
                <p class="text-gray-600 text-xs sm:text-sm mt-2">Click "Add Content" to get started</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
    <img id="lightbox-image" class="lightbox-content" onclick="event.stopPropagation()">
    <div id="lightbox-info" class="lightbox-info" onclick="event.stopPropagation()">
        <div id="lightbox-title" class="lightbox-title"></div>
        <div id="lightbox-caption" class="lightbox-caption"></div>
    </div>
</div>

<!-- Folder Modal -->
<div id="folderModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-2 sm:p-4" onclick="closeFolderModal()">
    <div class="bg-gray-900 rounded-lg max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col" style="background-color: rgb(18, 18, 20);" onclick="event.stopPropagation()">
        <div class="sticky top-0 z-10 flex justify-between items-center p-4 sm:p-6 border-b border-gray-700 flex-shrink-0" style="background-color: rgb(18, 18, 20);">
            <div>
                <h3 id="folderModalTitle" class="text-xl sm:text-2xl font-bold text-gray-200"></h3>
                <p id="folderModalDescription" class="text-sm text-gray-500 mt-1"></p>
            </div>
            <button onclick="closeFolderModal()" class="p-2 hover:bg-gray-700 rounded-lg">
                <svg class="w-6 h-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="folderContent" class="p-4 sm:p-6 overflow-y-auto flex-1">
            <div class="text-center py-8">
                <p class="text-gray-500">Loading...</p>
            </div>
        </div>
    </div>
</div>

<!-- Edit Folder Modal -->
{% if is_admin %}
<div id="editFolderModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="closeEditFolderModal()">
    <div class="bg-gray-900 rounded-lg max-w-md w-full p-6" style="background-color: rgb(18, 18, 20);" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold text-gray-200 mb-4">Edit Folder</h3>
        <input type="hidden" id="editFolderId">
        <div class="space-y-3">
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-1">Folder Name</label>
                <input
                    type="text"
                    id="editFolderName"
                    class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500"
                />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-1">Description</label>
                <textarea
                    id="editFolderDescription"
                    class="w-full px-4 py-2 border border-gray-600 rounded-lg h-20 bg-gray-800/50 text-gray-200 placeholder-gray-500"
                ></textarea>
            </div>
            <div class="flex gap-2">
                <button
                    onclick="saveEditFolder()"
                    class="px-4 py-2 bg-[#21525D] text-white rounded-lg hover:bg-[#1A1A1E]"
                >
                    Save Changes
                </button>
                <button
                    onclick="closeEditFolderModal()"
                    class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Content Modal (for folder content) -->
<div id="editContentModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="closeEditContentModal()">
    <div class="bg-gray-900 rounded-lg max-w-md w-full p-6" style="background-color: rgb(18, 18, 20);" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold text-gray-200 mb-4">Edit Content</h3>
        <input type="hidden" id="editContentId">
        <input type="hidden" id="editContentType">
        <div class="space-y-3">
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-1">Title</label>
                <input
                    type="text"
                    id="editContentTitle"
                    class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500"
                />
            </div>
            <div id="editContentUrlField">
                <label class="block text-sm font-medium text-gray-400 mb-1">Media URL</label>
                <input
                    type="url"
                    id="editContentUrl"
                    class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200 placeholder-gray-500"
                />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-1">Caption/Text</label>
                <textarea
                    id="editContentCaption"
                    class="w-full px-4 py-2 border border-gray-600 rounded-lg h-20 bg-gray-800/50 text-gray-200 placeholder-gray-500"
                ></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-1">Move to Folder</label>
                <select id="editContentFolder" class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-800/50 text-gray-200">
                    <option value="">Root (No Folder)</option>
                    {% for folder in folders %}
                    <option value="{{ folder._id }}">{{ folder.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex gap-2">
                <button
                    onclick="saveEditContent()"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                >
                    Save Changes
                </button>
                <button
                    onclick="closeEditContentModal()"
                    class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    const categoryId = '{{ category._id }}';
    let currentFolderId = null;

    // Close all admin forms
    function closeAllForms() {
        document.getElementById('addContentForm').classList.add('hidden');
        document.getElementById('bulkUploadForm').classList.add('hidden');
        document.getElementById('addFolderForm').classList.add('hidden');
    }

    function toggleEditCategory() {
        const form = document.getElementById('editCategoryForm');
        form.classList.toggle('hidden');
    }

    function toggleAddContent() {
        const form = document.getElementById('addContentForm');
        const isHidden = form.classList.contains('hidden');
        closeAllForms();
        if (isHidden) {
            form.classList.remove('hidden');
        }
    }

    function toggleBulkUpload() {
        const form = document.getElementById('bulkUploadForm');
        const isHidden = form.classList.contains('hidden');
        closeAllForms();
        if (isHidden) {
            form.classList.remove('hidden');
        }
    }

    function toggleAddFolder() {
        const form = document.getElementById('addFolderForm');
        const isHidden = form.classList.contains('hidden');
        closeAllForms();
        if (isHidden) {
            form.classList.remove('hidden');
        }
    }

    function toggleContentFields() {
        const type = document.getElementById('newContentType').value;
        const urlField = document.getElementById('contentUrlField');
        
        if (type === 'text') {
            urlField.style.display = 'none';
        } else {
            urlField.style.display = 'block';
        }
    }

    function saveCategory() {
        const name = document.getElementById('categoryName').value;
        const description = document.getElementById('categoryDescription').value;
        const bannerImage = document.getElementById('categoryBannerImage').value;
        const accentColor = document.getElementById('categoryColor').value;
        const isFree = document.getElementById('categoryFree').checked;

        fetch(`/api/categories/${categoryId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                name, 
                description,
                banner_image: bannerImage,
                accent_color: accentColor, 
                is_free: isFree 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update category');
        });
    }

    // Clear input functions
    function clearColorInput(textInputId, pickerInputId) {
        const defaultColor = '#4F46E5';
        document.getElementById(textInputId).value = defaultColor;
        document.getElementById(pickerInputId).value = defaultColor;
    }

    function clearBannerInput(inputId) {
        document.getElementById(inputId).value = '';
    }

    function addFolder() {
        const name = document.getElementById('newFolderName').value;
        const description = document.getElementById('newFolderDescription').value;

        if (!name) {
            alert('Please enter a folder name');
            return;
        }

        fetch('/api/folders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                category_id: categoryId,
                name: name,
                description: description
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to create folder');
        });
    }

    function editFolder(folderId, name, description) {
        document.getElementById('editFolderId').value = folderId;
        document.getElementById('editFolderName').value = name;
        document.getElementById('editFolderDescription').value = description || '';
        document.getElementById('editFolderModal').classList.remove('hidden');
    }

    function closeEditFolderModal() {
        document.getElementById('editFolderModal').classList.add('hidden');
    }

    function saveEditFolder() {
        const folderId = document.getElementById('editFolderId').value;
        const name = document.getElementById('editFolderName').value;
        const description = document.getElementById('editFolderDescription').value;

        fetch(`/api/folders/${folderId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update folder');
        });
    }

    function deleteFolder(folderId) {
        if (!confirm('Delete this folder and all its content?')) return;

        fetch(`/api/folders/${folderId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete folder');
        });
    }

    function openFolder(folderId) {
        currentFolderId = folderId;
        const folder = {{ folders|tojson }}.find(f => f._id === folderId);
        
        document.getElementById('folderModalTitle').textContent = folder.name;
        document.getElementById('folderModalDescription').textContent = folder.description || '';
        document.getElementById('folderModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        // Fetch folder content
        fetch(`/api/folders/${folderId}/content`)
            .then(response => response.json())
            .then(items => {
                const container = document.getElementById('folderContent');
                
                if (items.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                            </svg>
                            <p class="text-gray-500">This folder is empty</p>
                        </div>
                    `;
                    return;
                }

                let html = '<div class="content-grid grid gap-3 sm:gap-4">';
                items.forEach(item => {
                    html += `
                        <div id="content-${item._id}" class="content-card group relative bg-gray-800/50 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300">
                    `;

                    if (item.media_type === 'image') {
                        html += `
                            <div class="media-item" onclick="openLightbox('${item.media_url}', 'image', '${item.title || ''}', '${item.caption || ''}')">
                                <img src="${item.media_url}" alt="${item.title || ''}" loading="lazy" class="w-full h-auto">
                                ${(item.title || item.caption) ? `
                                    <div class="content-overlay">
                                        ${item.title ? `<div class="content-overlay-title">${item.title}</div>` : ''}
                                        ${item.caption ? `<div class="content-overlay-caption">${item.caption}</div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    } else if (item.media_type === 'video') {
                        html += `
                            <div class="relative">
                                <video controls class="w-full h-auto">
                                    <source src="${item.media_url}" type="video/mp4">
                                </video>
                                ${(item.title || item.caption) ? `
                                    <div class="content-overlay">
                                        ${item.title ? `<div class="content-overlay-title">${item.title}</div>` : ''}
                                        ${item.caption ? `<div class="content-overlay-caption">${item.caption}</div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="p-4">
                                ${item.title ? `<h4 class="font-semibold text-gray-200 text-base mb-2">${item.title}</h4>` : ''}
                                <p class="text-gray-400 text-sm whitespace-pre-wrap">${item.text || item.caption || ''}</p>
                            </div>
                        `;
                    }

                    // Add favorite button for all users
                    html += `
                        <button 
                            onclick="toggleFavorite('${item._id}', this)"
                            class="favorite-btn absolute top-2 left-2 w-9 h-9 rounded-full bg-black/70 hover:bg-black/90 flex items-center justify-center transition-all shadow-lg z-20"
                            data-favorited="false"
                            data-content-id="${item._id}"
                        >
                            <svg class="heart-icon w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                        </button>
                    `;

                    {% if is_admin %}
                    html += `
                        <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition z-20">
                            <button
                                onclick="editFolderContent('${item._id}', '${item.title || ''}', '${item.media_url || ''}', '${item.caption || ''}', '${item.media_type}', '${item.folder_id || ''}')"
                                class="p-2 bg-gray-900/90 text-white rounded hover:bg-gray-800"
                                title="Edit"
                            >
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button
                                onclick="deleteFolderContent('${item._id}')"
                                class="p-2 bg-red-600/90 text-white rounded hover:bg-red-700"
                                title="Delete"
                            >
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    `;
                    {% endif %}

                    html += '</div>';
                });
                html += '</div>';

                container.innerHTML = html;
                
                // Setup scroll listener to hide controls when content is under header
                const folderContentContainer = document.getElementById('folderContent');
                const folderModalHeader = document.querySelector('#folderModal .sticky');
                
                function updateControlsVisibility() {
                    const headerRect = folderModalHeader.getBoundingClientRect();
                    const headerBottom = headerRect.bottom;
                    
                    // Get all content cards
                    const contentCards = folderContentContainer.querySelectorAll('.content-card');
                    
                    contentCards.forEach(card => {
                        const cardRect = card.getBoundingClientRect();
                        const controls = card.querySelectorAll('.favorite-btn, .absolute.top-2.right-2');
                        
                        // If the top of the card is under the header, hide controls
                        if (cardRect.top < headerBottom) {
                            controls.forEach(control => {
                                control.style.opacity = '0';
                                control.style.pointerEvents = 'none';
                            });
                        } else {
                            controls.forEach(control => {
                                control.style.opacity = '';
                                control.style.pointerEvents = '';
                            });
                        }
                    });
                }
                
                // Add scroll listener
                folderContentContainer.addEventListener('scroll', updateControlsVisibility);
                
                // Initial check
                updateControlsVisibility();
                
                // Check favorite status for all content in folder
                const favoriteButtons = container.querySelectorAll('.favorite-btn');
                favoriteButtons.forEach(button => {
                    const contentId = button.dataset.contentId;
                    
                    fetch(`/api/favorites/check/${contentId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.is_favorited) {
                                button.dataset.favorited = 'true';
                                button.classList.remove('bg-black/70', 'hover:bg-black/90');
                                button.classList.add('bg-red-500', 'hover:bg-red-600');
                                const heartIcon = button.querySelector('.heart-icon');
                                heartIcon.setAttribute('fill', 'currentColor');
                            }
                        })
                        .catch(error => console.error('Error checking favorite:', error));
                });
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('folderContent').innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-red-500">Error loading folder content</p>
                    </div>
                `;
            });
    }

    function closeFolderModal() {
        const folderContentContainer = document.getElementById('folderContent');
        const folderModal = document.getElementById('folderModal');
        
        // Remove scroll listener by cloning and replacing the element
        const newContent = folderContentContainer.cloneNode(false);
        newContent.id = 'folderContent';
        newContent.className = folderContentContainer.className;
        newContent.innerHTML = `
            <div class="text-center py-8">
                <p class="text-gray-500">Loading...</p>
            </div>
        `;
        folderContentContainer.parentNode.replaceChild(newContent, folderContentContainer);
        
        folderModal.classList.add('hidden');
        document.body.style.overflow = '';
        currentFolderId = null;
    }

    function bulkUpload() {
        const urls = document.getElementById('bulkUrls').value.split('\n');
        const mediaType = document.getElementById('bulkMediaType').value;
        const folderId = document.getElementById('bulkContentFolder').value;

        if (urls.length === 0 || !urls[0].trim()) {
            alert('Please enter at least one URL');
            return;
        }

        fetch('/api/content/bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                category_id: categoryId,
                folder_id: folderId || null,
                media_type: mediaType,
                urls: urls
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Successfully uploaded ${data.created} items${data.failed > 0 ? `, ${data.failed} failed` : ''}`);
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to bulk upload');
        });
    }

    function addContent() {
        const type = document.getElementById('newContentType').value;
        const folderId = document.getElementById('newContentFolder').value;
        const title = document.getElementById('newContentTitle').value;
        const url = type !== 'text' ? document.getElementById('newContentUrl').value : '';
        const caption = document.getElementById('newContentCaption').value;

        if (type !== 'text' && !url) {
            alert('Please enter a media URL');
            return;
        }

        fetch('/api/content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                category_id: categoryId,
                folder_id: folderId || null,
                title: title,
                media_type: type,
                media_url: url,
                caption: caption,
                text: type === 'text' ? caption : ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add content');
        });
    }

    function toggleEdit(contentId) {
        const editForm = document.getElementById(`edit-form-${contentId}`);
        const contentDisplay = document.getElementById(`content-display-${contentId}`);
        
        editForm.classList.toggle('hidden');
        contentDisplay.classList.toggle('hidden');
    }

    function cancelEdit(contentId) {
        const editForm = document.getElementById(`edit-form-${contentId}`);
        const contentDisplay = document.getElementById(`content-display-${contentId}`);
        
        editForm.classList.add('hidden');
        contentDisplay.classList.remove('hidden');
    }

    function saveContentEdit(contentId) {
        const title = document.getElementById(`edit-title-${contentId}`).value;
        const urlField = document.getElementById(`edit-url-${contentId}`);
        const url = urlField ? urlField.value : '';
        const caption = document.getElementById(`edit-caption-${contentId}`).value;
        const folderId = document.getElementById(`edit-folder-${contentId}`).value;

        fetch(`/api/content/${contentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: title,
                media_url: url,
                caption: caption,
                text: caption,
                folder_id: folderId || null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update content');
        });
    }

    function deleteContent(contentId) {
        if (!confirm('Delete this content?')) return;

        fetch(`/api/content/${contentId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const element = document.getElementById(`content-${contentId}`);
                element.style.opacity = '0';
                element.style.transform = 'scale(0.9)';
                setTimeout(() => element.remove(), 300);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete content');
        });
    }

    // Update color preview
    document.addEventListener('DOMContentLoaded', function() {
        const colorInput = document.getElementById('categoryColor');
        const colorPicker = document.getElementById('categoryColorPicker');
        
        if (colorInput && colorPicker) {
            // Update picker when text input changes
            colorInput.addEventListener('input', function() {
                if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                    colorPicker.value = this.value;
                }
            });
            
            // Update text input when color picker changes
            colorPicker.addEventListener('input', function() {
                colorInput.value = this.value.toUpperCase();
            });
        }
    });

    // Lightbox functions
    function openLightbox(url, type, title, caption) {
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxInfo = document.getElementById('lightbox-info');
        const lightboxTitle = document.getElementById('lightbox-title');
        const lightboxCaption = document.getElementById('lightbox-caption');
        
        // Only handle images
        if (type !== 'image') return;
        
        // Set image
        lightboxImage.src = url;
        
        // Show info if title or caption exists
        if (title || caption) {
            lightboxTitle.textContent = title || '';
            lightboxCaption.textContent = caption || '';
            lightboxInfo.style.display = 'block';
            
            // Hide empty elements
            lightboxTitle.style.display = title ? 'block' : 'none';
            lightboxCaption.style.display = caption ? 'block' : 'none';
        } else {
            lightboxInfo.style.display = 'none';
        }
        
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent scrolling
    }

    function closeLightbox() {
        const lightbox = document.getElementById('lightbox');
        lightbox.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
    }

    // Close lightbox with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeLightbox();
        }
    });

    // Functions for editing/deleting content in folders
    function editFolderContent(contentId, title, url, caption, mediaType, currentFolder) {
        document.getElementById('editContentId').value = contentId;
        document.getElementById('editContentType').value = mediaType;
        document.getElementById('editContentTitle').value = title;
        document.getElementById('editContentUrl').value = url;
        document.getElementById('editContentCaption').value = caption;
        
        // Set current folder in dropdown
        const folderSelect = document.getElementById('editContentFolder');
        folderSelect.value = currentFolder || '';
        
        // Hide URL field for text content
        if (mediaType === 'text') {
            document.getElementById('editContentUrlField').style.display = 'none';
        } else {
            document.getElementById('editContentUrlField').style.display = 'block';
        }
        
        document.getElementById('editContentModal').classList.remove('hidden');
    }

    function closeEditContentModal() {
        document.getElementById('editContentModal').classList.add('hidden');
    }

    function saveEditContent() {
        const contentId = document.getElementById('editContentId').value;
        const title = document.getElementById('editContentTitle').value;
        const url = document.getElementById('editContentUrl').value;
        const caption = document.getElementById('editContentCaption').value;
        const mediaType = document.getElementById('editContentType').value;
        const folderId = document.getElementById('editContentFolder').value;

        fetch(`/api/content/${contentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: title,
                media_url: url,
                caption: caption,
                text: caption,
                folder_id: folderId || null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeEditContentModal();
                // Always reload page to show new position of content
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update content');
        });
    }

    function deleteFolderContent(contentId) {
        if (!confirm('Delete this content?')) return;

        fetch(`/api/content/${contentId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the element from the folder modal
                const element = document.getElementById(`content-${contentId}`);
                if (element) {
                    element.style.opacity = '0';
                    element.style.transform = 'scale(0.9)';
                    setTimeout(() => element.remove(), 300);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete content');
        });
    }

    // ============================
    // FAVORITES FUNCTIONALITY
    // ============================

    function toggleFavorite(contentId, button) {
        const isFavorited = button.dataset.favorited === 'true';
        const method = isFavorited ? 'DELETE' : 'POST';

        fetch(`/api/favorites/${contentId}`, { method })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Toggle state
                    button.dataset.favorited = (!isFavorited).toString();
                    
                    // Update button appearance
                    const heartIcon = button.querySelector('.heart-icon');
                    if (!isFavorited) {
                        // Now favorited - filled heart
                        button.classList.remove('bg-black/70', 'hover:bg-black/90');
                        button.classList.add('bg-red-500', 'hover:bg-red-600');
                        heartIcon.setAttribute('fill', 'currentColor');
                    } else {
                        // Now unfavorited - outline heart
                        button.classList.remove('bg-red-500', 'hover:bg-red-600');
                        button.classList.add('bg-black/70', 'hover:bg-black/90');
                        heartIcon.setAttribute('fill', 'none');
                    }
                    
                    // Add animation
                    button.classList.add('scale-125');
                    setTimeout(() => button.classList.remove('scale-125'), 200);
                    
                    // Update favorites counter if function exists
                    if (typeof window.updateFavoritesCounter === 'function') {
                        window.updateFavoritesCounter();
                    }
                } else if (data.limit_reached) {
                    // Show favorites limit modal
                    if (typeof window.showFavoritesLimitModal === 'function') {
                        window.showFavoritesLimitModal();
                    } else {
                        // Fallback to alert if modal function not available
                        alert(data.message || 'You have reached the maximum of 50 favorites. Upgrade to premium for unlimited favorites!');
                    }
                } else {
                    console.error('Error toggling favorite:', data.error);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Check favorite status for all content on page load
    document.addEventListener('DOMContentLoaded', function() {
        const favoriteButtons = document.querySelectorAll('.favorite-btn');
        
        favoriteButtons.forEach(button => {
            const contentId = button.dataset.contentId;
            
            fetch(`/api/favorites/check/${contentId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.is_favorited) {
                        button.dataset.favorited = 'true';
                        button.classList.remove('bg-black/70', 'hover:bg-black/90');
                        button.classList.add('bg-red-500', 'hover:bg-red-600');
                        const heartIcon = button.querySelector('.heart-icon');
                        heartIcon.setAttribute('fill', 'currentColor');
                    }
                })
                .catch(error => console.error('Error checking favorite:', error));
        });
    });

</script>
{% endblock %}