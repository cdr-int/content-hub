{% extends "base.html" %}

{% block title %}{{ category.name }} - Content Hub{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <!-- Category Header -->
        <div class="gradient-bg px-6 py-6 text-white" style="--gradient-start: {{ category.accent_color }}; --gradient-end: {{ category.accent_color }}dd;">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h2 class="text-2xl font-bold mb-1">{{ category.name }}</h2>
                    <p class="text-white/90 text-sm">
                        {% if category.is_free %}Free Content{% else %}Premium Content{% endif %}
                    </p>
                    {% if category.description %}
                    <p class="text-white/80 text-sm mt-2">{{ category.description }}</p>
                    {% endif %}
                </div>
                {% if is_admin %}
                <div class="flex gap-2">
                    <button onclick="toggleEditCategory()" class="p-2 text-white hover:bg-white/20 rounded">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                    <button onclick="deleteCategory()" class="p-2 text-white hover:bg-white/20 rounded">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        {% if is_admin %}
        <!-- Edit Category Form (Admin Only) -->
        <div id="editCategoryForm" class="hidden p-6 bg-gray-50 border-b">
            <h3 class="text-lg font-semibold mb-4">Edit Category</h3>
            <div class="space-y-3">
                <input
                    type="text"
                    id="categoryName"
                    value="{{ category.name }}"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    placeholder="Category name"
                />
                <textarea
                    id="categoryDescription"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg h-24"
                    placeholder="Category description"
                >{{ category.description if category.description else '' }}</textarea>
                <div class="flex gap-2">
                    <input
                        type="text"
                        id="categoryColor"
                        value="{{ category.accent_color }}"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg font-mono"
                        placeholder="#4F46E5"
                    />
                    <div 
                        id="colorPreview"
                        class="w-12 h-10 rounded border-2 border-gray-300"
                        style="background-color: {{ category.accent_color }}"
                    ></div>
                    <label class="flex items-center gap-2 px-4 py-2 bg-white rounded-lg cursor-pointer border border-gray-300">
                        <input
                            type="checkbox"
                            id="categoryFree"
                            {% if category.is_free %}checked{% endif %}
                            class="w-4 h-4"
                        />
                        <span class="text-sm">Free</span>
                    </label>
                </div>
                <div class="flex gap-2">
                    <button
                        onclick="saveCategory()"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                    >
                        <svg class="w-4 h-4 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                        Save
                    </button>
                    <button
                        onclick="toggleEditCategory()"
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Content Form (Admin Only) -->
        <div class="p-6 bg-gray-50 border-b">
            <button
                onclick="toggleAddContent()"
                class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 mb-4"
            >
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add New Content
            </button>
            
            <div id="addContentForm" class="hidden space-y-3 bg-white p-4 rounded-lg border">
                <select
                    id="contentType"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    onchange="updateContentForm()"
                >
                    <option value="text">Text Only</option>
                    <option value="image">Image</option>
                    <option value="video">Video</option>
                </select>
                <input
                    type="text"
                    id="contentTitle"
                    placeholder="Title (optional)"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                />
                <div id="urlField">
                    <input
                        type="text"
                        id="contentUrl"
                        placeholder="URL"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    />
                </div>
                <textarea
                    id="contentCaption"
                    placeholder="Caption / Content"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg h-24"
                ></textarea>
                <div class="flex gap-2">
                    <button
                        onclick="addContent()"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                    >
                        Add Content
                    </button>
                    <button
                        onclick="toggleAddContent()"
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Content Items -->
        <div class="p-6">
            {% if content_items|length == 0 %}
            <p class="text-gray-500 text-center py-12">No content in this category yet</p>
            {% else %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for item in content_items %}
                <div id="content-{{ item._id }}" class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition">
                    {% if item.media_type == 'image' %}
                    <img src="{{ item.media_url }}" alt="{{ item.caption }}" class="w-full h-56 object-cover" />
                    {% elif item.media_type == 'video' %}
                    <video src="{{ item.media_url }}" controls class="w-full h-56 bg-black"></video>
                    {% endif %}
                    
                    {% if item.title or item.caption or item.text %}
                    <div class="p-4 bg-gray-50">
                        {% if item.title %}
                        <h4 class="font-semibold text-gray-800 mb-2">{{ item.title }}</h4>
                        {% endif %}
                        {% if item.caption %}
                        <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ item.caption }}</p>
                        {% endif %}
                        {% if item.text %}
                        <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ item.text }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if is_admin %}
                    <div class="p-2 bg-gray-100 flex justify-end gap-2">
                        <button
                            onclick="editContent('{{ item._id }}')"
                            class="p-1 text-indigo-600 hover:bg-indigo-50 rounded"
                        >
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button
                            onclick="deleteContent('{{ item._id }}')"
                            class="p-1 text-red-600 hover:bg-red-50 rounded"
                        >
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const categoryId = '{{ category._id }}';

    function toggleEditCategory() {
        const form = document.getElementById('editCategoryForm');
        form.classList.toggle('hidden');
    }

    function toggleAddContent() {
        const form = document.getElementById('addContentForm');
        form.classList.toggle('hidden');
        if (!form.classList.contains('hidden')) {
            updateContentForm();
        }
    }

    function updateContentForm() {
        const type = document.getElementById('contentType').value;
        const urlField = document.getElementById('urlField');
        
        if (type === 'text') {
            urlField.classList.add('hidden');
        } else {
            urlField.classList.remove('hidden');
        }
    }

    function saveCategory() {
        const name = document.getElementById('categoryName').value;
        const description = document.getElementById('categoryDescription').value;
        const accentColor = document.getElementById('categoryColor').value;
        const isFree = document.getElementById('categoryFree').checked;

        if (!/^#[0-9A-F]{6}$/i.test(accentColor)) {
            alert('Please enter a valid hex color code (e.g., #4F46E5)');
            return;
        }

        fetch(`/api/categories/${categoryId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, accent_color: accentColor, is_free: isFree })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update category');
        });
    }

    function deleteCategory() {
        if (!confirm('Delete this category and all its content?')) return;

        fetch(`/api/categories/${categoryId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/categories';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete category');
        });
    }

    function addContent() {
        const type = document.getElementById('contentType').value;
        const title = document.getElementById('contentTitle').value;
        const url = document.getElementById('contentUrl').value;
        const caption = document.getElementById('contentCaption').value;

        if (type !== 'text' && !url) {
            alert('Please provide a URL');
            return;
        }

        fetch('/api/content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                category_id: categoryId,
                title: title,
                media_type: type,
                media_url: url,
                caption: caption,
                text: type === 'text' ? caption : ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add content');
        });
    }

    function deleteContent(contentId) {
        if (!confirm('Delete this content?')) return;

        fetch(`/api/content/${contentId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`content-${contentId}`).remove();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete content');
        });
    }

    // Update color preview
    document.addEventListener('DOMContentLoaded', function() {
        const colorInput = document.getElementById('categoryColor');
        const colorPreview = document.getElementById('colorPreview');
        
        if (colorInput && colorPreview) {
            colorInput.addEventListener('input', function() {
                if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                    colorPreview.style.backgroundColor = this.value;
                }
            });
        }
    });
</script>
{% endblock %}
