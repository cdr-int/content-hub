{% extends "base.html" %}

{% block title %}{{ category.name }} - Content Hub{% endblock %}

{% block content %}
<style>
    .category-accent-btn {
        background-color: {{ category.accent_color }};
    }
    .category-accent-btn:hover {
        opacity: 0.9;
    }
    .category-accent-border:hover {
        border-color: {{ category.accent_color }};
    }
    .category-accent-text {
        color: {{ category.accent_color }};
    }
    .category-accent-bg {
        background-color: {{ category.accent_color }}20;
    }
    .category-accent-ring:focus {
        --tw-ring-color: {{ category.accent_color }};
    }
</style>

<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <!-- Category Header -->
        <div class="gradient-bg px-6 py-8 text-white relative overflow-hidden" style="--gradient-start: {{ category.accent_color }}; --gradient-end: {{ category.accent_color }}dd;">
            <!-- Decorative Pattern -->
            <div class="absolute inset-0 opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;%3E%3Cg fill=&quot;%23ffffff&quot; fill-opacity=&quot;1&quot;%3E%3Cpath d=&quot;M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z&quot;/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
            
            <div class="flex justify-between items-start relative z-10">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <h2 class="text-3xl font-bold">{{ category.name }}</h2>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold {% if category.is_free %}bg-green-500{% else %}bg-purple-500{% endif %}">
                            {% if category.is_free %}Free{% else %}Premium{% endif %}
                        </span>
                    </div>
                    {% if category.description %}
                    <p class="text-white/90 text-base mt-3 max-w-3xl whitespace-pre-wrap">{{ category.description }}</p>
                    {% endif %}
                </div>
                {% if is_admin %}
                <div class="flex gap-2">
                    <button onclick="toggleEditCategory()" class="p-2 text-white hover:bg-white/20 rounded-lg transition" title="Edit Category">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                    <button onclick="deleteCategory()" class="p-2 text-white hover:bg-white/20 rounded-lg transition" title="Delete Category">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        {% if is_admin %}
        <!-- Edit Category Form (Admin Only) -->
        <div id="editCategoryForm" class="hidden p-6 bg-gradient-to-br from-gray-50 to-gray-100 border-b">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">Edit Category</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category Name</label>
                    <input
                        type="text"
                        id="categoryName"
                        value="{{ category.name }}"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent"
                        placeholder="Category name"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea
                        id="categoryDescription"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent h-32 resize-y"
                        placeholder="Category description (supports multiple lines)"
                    >{{ category.description if category.description else '' }}</textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Accent Color</label>
                        <div class="flex gap-2">
                            <input
                                type="text"
                                id="categoryColor"
                                value="{{ category.accent_color }}"
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg font-mono focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="#4F46E5"
                            />
                            <div 
                                id="colorPreview"
                                class="w-12 h-10 rounded-lg border-2 border-gray-300 shadow-inner"
                                style="background-color: {{ category.accent_color }}"
                            ></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Access Type</label>
                        <label class="flex items-center gap-2 px-4 py-2 bg-white rounded-lg cursor-pointer border-2 category-accent-border border-gray-300 hover:border-indigo-400 transition h-10">
                            <input
                                type="checkbox"
                                id="categoryFree"
                                {% if category.is_free %}checked{% endif %}
                                class="w-4 h-4"
                                style="accent-color: {{ category.accent_color }}"
                            />
                            <span class="text-sm font-medium text-gray-700">Free Access</span>
                        </label>
                    </div>
                </div>
                <div class="flex gap-2 pt-4">
                    <button
                        onclick="saveCategory()"
                        class="flex items-center gap-2 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                    >
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Save Changes
                    </button>
                    <button
                        onclick="toggleEditCategory()"
                        class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Content Form (Admin Only) -->
        <div class="p-6 bg-gray-50 border-b">
            <button
                onclick="toggleAddContent()"
                class="flex items-center gap-2 px-6 py-3 category-accent-btn text-white rounded-lg transition shadow-md hover:shadow-lg mb-4"
            >
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add New Content
            </button>
            
            <div id="addContentForm" class="hidden space-y-4 bg-white p-6 rounded-lg border shadow-sm">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Content Type</label>
                    <select
                        id="contentType"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent"
                        onchange="updateContentForm()"
                    >
                        <option value="text">Text Only</option>
                        <option value="image">Image</option>
                        <option value="video">Video</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title (optional)</label>
                    <input
                        type="text"
                        id="contentTitle"
                        placeholder="Enter a title for this content"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent"
                    />
                </div>
                <div id="urlField">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Media URL</label>
                    <input
                        type="text"
                        id="contentUrl"
                        placeholder="https://example.com/image.jpg"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Caption / Content</label>
                    <textarea
                        id="contentCaption"
                        placeholder="Add a description or text content (supports multiple lines)"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent h-32 resize-y"
                    ></textarea>
                </div>
                <div class="flex gap-2 pt-2">
                    <button
                        onclick="addContent()"
                        class="flex items-center gap-2 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                    >
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Add Content
                    </button>
                    <button
                        onclick="toggleAddContent()"
                        class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Content Items -->
        <div class="p-6">
            {% if content_items|length == 0 %}
            <div class="text-center py-20">
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-full category-accent-bg mb-4">
                    <svg class="w-10 h-10 category-accent-text" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No content yet</h3>
                <p class="text-gray-500">This category doesn't have any content at the moment.</p>
                {% if is_admin %}
                <p class="text-gray-400 text-sm mt-2">Click "Add New Content" above to get started.</p>
                {% endif %}
            </div>
            {% else %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for item in content_items %}
                <div id="content-{{ item._id }}" class="group bg-white border-2 category-accent-border border-gray-200 rounded-xl overflow-hidden hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
                    <!-- Edit Form (Hidden by default) -->
                    {% if is_admin %}
                    <div id="edit-form-{{ item._id }}" class="hidden p-4 category-accent-bg border-b space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Title</label>
                            <input
                                type="text"
                                id="edit-title-{{ item._id }}"
                                value="{{ item.title if item.title else '' }}"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent"
                                placeholder="Title"
                            />
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Media URL</label>
                            <input
                                type="text"
                                id="edit-url-{{ item._id }}"
                                value="{{ item.media_url if item.media_url else '' }}"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent"
                                placeholder="URL"
                            />
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Caption</label>
                            <textarea
                                id="edit-caption-{{ item._id }}"
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg category-accent-ring focus:ring-2 focus:border-transparent h-24 resize-y"
                                placeholder="Caption (supports multiple lines)"
                            >{{ item.caption if item.caption else '' }}</textarea>
                        </div>
                        <div class="flex gap-2">
                            <button
                                onclick="saveContentEdit('{{ item._id }}')"
                                class="flex-1 flex items-center justify-center gap-2 px-3 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                            >
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                Save
                            </button>
                            <button
                                onclick="cancelEdit('{{ item._id }}')"
                                class="flex-1 px-3 py-2 text-sm bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Media Display -->
                    {% if item.media_type == 'image' %}
                    <div class="relative h-56 bg-gray-100 overflow-hidden">
                        <img src="{{ item.media_url }}" alt="{{ item.caption }}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" />
                        <div class="absolute top-2 right-2">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full category-accent-btn text-white shadow-lg">Image</span>
                        </div>
                    </div>
                    {% elif item.media_type == 'video' %}
                    <div class="relative h-56 bg-black">
                        <video src="{{ item.media_url }}" controls class="w-full h-full"></video>
                        <div class="absolute top-2 right-2">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-500 text-white shadow-lg">Video</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="relative h-56 category-accent-bg flex items-center justify-center">
                        <svg class="w-16 h-16 category-accent-text" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <div class="absolute top-2 right-2">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-500 text-white shadow-lg">Text</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Content Display -->
                    <div id="content-display-{{ item._id }}">
                        {% if item.title or item.caption or item.text %}
                        <div class="p-5">
                            {% if item.title %}
                            <h4 class="font-bold text-gray-800 mb-2 text-lg">{{ item.title }}</h4>
                            {% endif %}
                            {% if item.caption %}
                            <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">{{ item.caption }}</p>
                            {% endif %}
                            {% if item.text and item.text != item.caption %}
                            <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap mt-2">{{ item.text }}</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if is_admin %}
                    <div class="p-3 bg-gray-50 border-t flex justify-end gap-2">
                        <button
                            onclick="toggleEdit('{{ item._id }}')"
                            class="flex items-center gap-1 px-3 py-2 text-sm category-accent-text category-accent-bg rounded-lg transition"
                            title="Edit content"
                        >
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            Edit
                        </button>
                        <button
                            onclick="deleteContent('{{ item._id }}')"
                            class="flex items-center gap-1 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition"
                            title="Delete content"
                        >
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Delete
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const categoryId = '{{ category._id }}';

    function toggleEditCategory() {
        const form = document.getElementById('editCategoryForm');
        form.classList.toggle('hidden');
    }

    function toggleAddContent() {
        const form = document.getElementById('addContentForm');
        form.classList.toggle('hidden');
        if (!form.classList.contains('hidden')) {
            updateContentForm();
        }
    }

    function updateContentForm() {
        const type = document.getElementById('contentType').value;
        const urlField = document.getElementById('urlField');
        
        if (type === 'text') {
            urlField.classList.add('hidden');
        } else {
            urlField.classList.remove('hidden');
        }
    }

    function saveCategory() {
        const name = document.getElementById('categoryName').value;
        const description = document.getElementById('categoryDescription').value;
        const accentColor = document.getElementById('categoryColor').value;
        const isFree = document.getElementById('categoryFree').checked;

        if (!/^#[0-9A-F]{6}$/i.test(accentColor)) {
            alert('Please enter a valid hex color code (e.g., #4F46E5)');
            return;
        }

        fetch(`/api/categories/${categoryId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, accent_color: accentColor, is_free: isFree })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update category');
        });
    }

    function deleteCategory() {
        if (!confirm('Delete this category and all its content?')) return;

        fetch(`/api/categories/${categoryId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/categories';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete category');
        });
    }

    function addContent() {
        const type = document.getElementById('contentType').value;
        const title = document.getElementById('contentTitle').value;
        const url = document.getElementById('contentUrl').value;
        const caption = document.getElementById('contentCaption').value;

        if (type !== 'text' && !url) {
            alert('Please provide a URL');
            return;
        }

        fetch('/api/content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                category_id: categoryId,
                title: title,
                media_type: type,
                media_url: url,
                caption: caption,
                text: type === 'text' ? caption : ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to add content');
        });
    }

    function toggleEdit(contentId) {
        const editForm = document.getElementById(`edit-form-${contentId}`);
        const contentDisplay = document.getElementById(`content-display-${contentId}`);
        
        editForm.classList.toggle('hidden');
        contentDisplay.classList.toggle('hidden');
    }

    function cancelEdit(contentId) {
        const editForm = document.getElementById(`edit-form-${contentId}`);
        const contentDisplay = document.getElementById(`content-display-${contentId}`);
        
        editForm.classList.add('hidden');
        contentDisplay.classList.remove('hidden');
    }

    function saveContentEdit(contentId) {
        const title = document.getElementById(`edit-title-${contentId}`).value;
        const url = document.getElementById(`edit-url-${contentId}`).value;
        const caption = document.getElementById(`edit-caption-${contentId}`).value;

        fetch(`/api/content/${contentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: title,
                media_url: url,
                caption: caption,
                text: caption
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update content');
        });
    }

    function deleteContent(contentId) {
        if (!confirm('Delete this content?')) return;

        fetch(`/api/content/${contentId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const element = document.getElementById(`content-${contentId}`);
                element.style.opacity = '0';
                element.style.transform = 'scale(0.9)';
                setTimeout(() => element.remove(), 300);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete content');
        });
    }

    // Update color preview
    document.addEventListener('DOMContentLoaded', function() {
        const colorInput = document.getElementById('categoryColor');
        const colorPreview = document.getElementById('colorPreview');
        
        if (colorInput && colorPreview) {
            colorInput.addEventListener('input', function() {
                if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                    colorPreview.style.backgroundColor = this.value;
                }
            });
        }
    });
</script>
{% endblock %}